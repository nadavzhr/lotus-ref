<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DCFG Editor</title>
<style>
  :root {
    --bg: #1e1e2e;
    --surface: #282840;
    --surface2: #313150;
    --text: #cdd6f4;
    --subtext: #a6adc8;
    --green: #a6e3a1;
    --yellow: #f9e2af;
    --red: #f38ba8;
    --blue: #89b4fa;
    --lavender: #b4befe;
    --overlay: #45475a;
    --comment-color: #6c7086;
    --empty-color: #45475a;
    --teal: #94e2d5;
    --peach: #fab387;
    --purple: #cba6f7;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    line-height: 1.5;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
  h1 { font-size: 18px; color: var(--lavender); margin-bottom: 12px; }
  h2 { font-size: 14px; color: var(--blue); margin-bottom: 8px; }
  h3 { font-size: 12px; color: var(--teal); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

  /* --- Load panel --- */
  .load-panel {
    background: var(--surface);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .load-panel label { color: var(--subtext); font-size: 12px; }
  .load-panel input, .load-panel select {
    background: var(--surface2);
    border: 1px solid var(--overlay);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 12px;
  }
  .load-panel input { flex: 1; min-width: 300px; }
  button {
    background: var(--blue);
    color: var(--bg);
    border: none;
    padding: 6px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
  }
  button:hover { opacity: 0.85; }
  button.save-btn { background: var(--green); }
  button.cancel-btn { background: var(--overlay); color: var(--text); }
  button.teal-btn { background: var(--teal); color: var(--bg); }
  button.peach-btn { background: var(--peach); color: var(--bg); }
  button.small-btn { padding: 2px 8px; font-size: 11px; border-radius: 3px; }
  button.danger-btn { background: var(--red); color: var(--bg); }

  /* --- Status bar --- */
  .status-bar {
    background: var(--surface);
    border-radius: 8px;
    padding: 8px 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--subtext);
  }
  .status-bar .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 11px;
  }
  .badge-ok { background: var(--green); color: var(--bg); }
  .badge-warning { background: var(--yellow); color: var(--bg); }
  .badge-error { background: var(--red); color: var(--bg); }
  .badge-comment { background: var(--comment-color); color: var(--text); }
  .badge-empty { background: var(--empty-color); color: var(--subtext); }
  .badge-conflict { background: var(--purple); color: var(--bg); }

  /* --- Line table --- */
  .lines-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
  }
  .lines-table th {
    background: var(--surface2);
    padding: 6px 12px;
    text-align: left;
    font-size: 11px;
    color: var(--subtext);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .lines-table td {
    padding: 4px 12px;
    border-bottom: 1px solid var(--overlay);
    vertical-align: top;
  }
  .lines-table tr:hover { background: var(--surface2); }
  .lines-table tr.status-ok td:first-child { border-left: 3px solid var(--green); }
  .lines-table tr.status-warning td:first-child { border-left: 3px solid var(--yellow); }
  .lines-table tr.status-error td:first-child { border-left: 3px solid var(--red); }
  .lines-table tr.status-comment td:first-child { border-left: 3px solid var(--comment-color); }
  .lines-table tr.status-empty td:first-child { border-left: 3px solid var(--empty-color); }
  .lines-table tr.status-conflict td:first-child { border-left: 3px solid var(--purple); }
  .lines-table tr.status-comment td { color: var(--comment-color); }
  .lines-table tr.status-empty td { color: var(--empty-color); }

  .line-num { color: var(--overlay); text-align: right; width: 40px; font-size: 11px; }
  .line-status { width: 70px; }
  .line-status .pill {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .pill-ok { background: rgba(166,227,161,0.15); color: var(--green); }
  .pill-warning { background: rgba(249,226,175,0.15); color: var(--yellow); }
  .pill-error { background: rgba(243,139,168,0.15); color: var(--red); }
  .pill-comment { background: rgba(108,112,134,0.15); color: var(--comment-color); }
  .pill-empty { background: rgba(69,71,90,0.15); color: var(--empty-color); }
  .pill-conflict { background: rgba(203,166,247,0.15); color: var(--purple); }

  .line-text {
    white-space: pre-wrap;
    word-break: break-all;
    max-width: 700px;
  }
  .line-messages { font-size: 11px; max-width: 400px; }
  .line-messages .err { color: var(--red); }
  .line-messages .warn { color: var(--yellow); }

  .edit-col { width: 120px; text-align: center; white-space: nowrap; }
  .edit-btn {
    background: var(--surface2);
    color: var(--lavender);
    border: 1px solid var(--overlay);
    padding: 2px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
  }
  .edit-btn:hover { background: var(--overlay); }
  .action-btn {
    background: var(--surface2);
    color: var(--subtext);
    border: 1px solid var(--overlay);
    padding: 2px 7px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
    margin-left: 3px;
  }
  .action-btn:hover { background: var(--overlay); }
  .action-btn.del:hover { background: var(--red); color: var(--bg); }
  .action-btn.ins:hover { background: var(--teal); color: var(--bg); }

  /* --- Edit panel --- */
  .edit-panel {
    background: var(--surface);
    border: 1px solid var(--blue);
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
    display: none;
  }
  .edit-panel.open { display: block; }
  .edit-panel h2 { margin-bottom: 12px; }
  .edit-form { display: flex; flex-wrap: wrap; gap: 12px; }
  .field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .field-group label {
    font-size: 11px;
    color: var(--subtext);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .field-group input[type="text"],
  .field-group input[type="number"],
  .field-group select {
    background: var(--surface2);
    border: 1px solid var(--overlay);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 12px;
    min-width: 160px;
  }
  .field-group input[type="checkbox"] { width: 16px; height: 16px; }
  .checkbox-row { display: flex; gap: 16px; align-items: center; }
  .checkbox-row label {
    display: flex; align-items: center; gap: 4px;
    font-size: 12px; color: var(--text); text-transform: none;
  }
  .edit-actions { display: flex; gap: 8px; margin-top: 12px; }

  .edit-result {
    margin-top: 12px;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    display: none;
  }
  .edit-result.show { display: block; }
  .edit-result.success { background: rgba(166,227,161,0.1); border: 1px solid var(--green); color: var(--green); }
  .edit-result.failure { background: rgba(243,139,168,0.1); border: 1px solid var(--red); color: var(--red); }

  /* --- NQS Query Preview --- */
  .query-section {
    background: var(--surface2);
    border: 1px solid var(--overlay);
    border-radius: 6px;
    padding: 12px;
    margin-top: 12px;
    flex-basis: 100%;
  }
  .query-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  .query-row input {
    background: var(--bg);
    border: 1px solid var(--overlay);
    color: var(--text);
    padding: 5px 8px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 12px;
    min-width: 200px;
  }
  .query-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--overlay);
    border-radius: 4px;
    background: var(--bg);
  }
  .query-results:empty { display: none; }
  .query-results .result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 8px;
    font-size: 12px;
    border-bottom: 1px solid var(--overlay);
  }
  .query-results .result-item:last-child { border-bottom: none; }
  .query-results .result-item:hover { background: var(--surface); }
  .query-results .result-count {
    padding: 4px 8px;
    font-size: 11px;
    color: var(--subtext);
    border-bottom: 1px solid var(--overlay);
    background: var(--surface2);
  }

  /* --- Mutex Lists --- */
  .lists-container {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    flex-basis: 100%;
  }
  .entry-list {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--overlay);
    border-radius: 6px;
    overflow: hidden;
  }
  .entry-list-header {
    background: var(--overlay);
    padding: 6px 10px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .entry-list-header .count {
    background: var(--surface);
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 10px;
  }
  .entry-list-body {
    max-height: 200px;
    overflow-y: auto;
  }
  .entry-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 10px;
    font-size: 12px;
    border-bottom: 1px solid var(--overlay);
  }
  .entry-item:last-child { border-bottom: none; }
  .entry-item:hover { background: var(--bg); }
  .entry-item .net-name { flex: 1; }
  .entry-item .net-meta {
    font-size: 10px;
    color: var(--subtext);
    margin-left: 8px;
  }
  .entry-item .entry-actions {
    display: flex;
    gap: 4px;
    margin-left: 8px;
  }
  .entry-item-active {
    background: rgba(148,226,213,0.08);
  }
  .session-info {
    margin-top: 8px;
    padding: 8px 12px;
    background: var(--surface2);
    border-radius: 4px;
    font-size: 11px;
    color: var(--subtext);
    flex-basis: 100%;
  }
  .session-info span { margin-right: 16px; }
  .session-info .val { color: var(--text); font-weight: 600; }

  .hidden { display: none; }
  #doc-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
  }
</style>
</head>
<body>
<div class="container">
  <h1>âš¡ DCFG Editor Prototype</h1>

  <!-- Load panel -->
  <div class="load-panel">
    <label>File path:</label>
    <input type="text" id="file-path" placeholder="/path/to/file.dcfg">
    <label>Type:</label>
    <select id="doc-type">
      <option value="af">AF</option>
      <option value="mutex">Mutex</option>
    </select>
    <button onclick="loadDoc()">Load</button>
  </div>

  <!-- Document view (hidden until loaded) -->
  <div id="doc-view" class="hidden">
    <div id="doc-toolbar">
      <h2 id="doc-title"></h2>
      <button class="teal-btn" onclick="insertLineAt(0)" title="Insert a new line at the top">+ New Line</button>
      <button class="save-btn" onclick="saveDoc()">ðŸ’¾ Save</button>
    </div>
    <div id="status-bar" class="status-bar"></div>

    <!-- Edit panel -->
    <div id="edit-panel" class="edit-panel">
      <h2>Editing line <span id="edit-line-num"></span></h2>
      <div id="edit-form" class="edit-form"></div>
      <div class="edit-actions" id="edit-actions">
        <button onclick="submitEdit()">Apply</button>
        <button class="cancel-btn" onclick="closeEdit()">Cancel</button>
      </div>
      <div id="edit-result" class="edit-result"></div>
    </div>

    <table class="lines-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Status</th>
          <th>Raw Text</th>
          <th>Messages</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="lines-body"></tbody>
    </table>
  </div>
</div>

<script>
const API = '/api';
let currentDocId = null;
let currentDocType = null;
let editingPosition = null;
let editingLineData = null;
let linesData = [];
let mutexSession = null;

// ---- Helpers ----

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function pillHtml(status) {
  return `<span class="pill pill-${status}">${status}</span>`;
}

function badgeHtml(label, count, cls) {
  return `<span class="badge ${cls}">${label}: ${count}</span>`;
}

function showResult(msg, isSuccess) {
  const el = document.getElementById('edit-result');
  el.className = `edit-result show ${isSuccess ? 'success' : 'failure'}`;
  el.textContent = msg;
}

// ---- Load Document ----

async function loadDoc() {
  const filePath = document.getElementById('file-path').value.trim();
  const docType = document.getElementById('doc-type').value;
  if (!filePath) return alert('Enter a file path');

  const docId = filePath.split('/').pop().replace(/\./g, '_');

  try {
    const res = await fetch(`${API}/documents/load`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ doc_id: docId, file_path: filePath, doc_type: docType })
    });
    if (!res.ok) {
      const err = await res.json();
      return alert(`Load failed: ${err.detail || res.statusText}`);
    }
    const summary = await res.json();
    currentDocId = docId;
    currentDocType = docType;
    document.getElementById('doc-title').textContent =
      `${summary.file_path}  (${summary.total_lines} lines)`;
    renderStatusBar(summary.status_counts);
    await refreshLines();
    document.getElementById('doc-view').classList.remove('hidden');
    closeEdit();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function renderStatusBar(counts) {
  const bar = document.getElementById('status-bar');
  bar.innerHTML = [
    counts.ok ? badgeHtml('OK', counts.ok, 'badge-ok') : '',
    counts.warning ? badgeHtml('WARN', counts.warning, 'badge-warning') : '',
    counts.error ? badgeHtml('ERROR', counts.error, 'badge-error') : '',
    counts.conflict ? badgeHtml('CONFLICT', counts.conflict, 'badge-conflict') : '',
    counts.comment ? badgeHtml('COMMENT', counts.comment, 'badge-comment') : '',
  ].filter(Boolean).join('');
}

// ---- Lines Table ----

async function refreshLines() {
  const res = await fetch(`${API}/documents/${currentDocId}/lines`);
  linesData = await res.json();
  renderLines(linesData);
}

function renderLines(lines) {
  const tbody = document.getElementById('lines-body');

  tbody.innerHTML = lines.map(line => {
    const msgs = [
      ...line.errors.map(e => `<span class="err">âœ— ${esc(e)}</span>`),
      ...line.warnings.map(w => `<span class="warn">âš  ${esc(w)}</span>`),
    ];

    // Show conflict info if present
    if (line.conflict_info) {
      const otherLines = line.conflict_info.conflicting_positions
        .map(p => '#' + (p + 1))
        .join(', ');
      const nets = line.conflict_info.shared_nets.join(', ');
      msgs.push(`<span style="color:var(--purple)">âš¡ Conflicts with line${line.conflict_info.conflicting_positions.length > 1 ? 's' : ''} ${esc(otherLines)} (shared: ${esc(nets)})</span>`);
    }

    const editBtn = line.status !== 'comment'
      ? `<button class="edit-btn" onclick="startEdit(${line.position})" title="Edit this line">Edit</button>`
      : '';
    const insBtn = `<button class="action-btn ins" onclick="insertLineAt(${line.position + 1})" title="Insert new line below">+</button>`;
    const delBtn = `<button class="action-btn del" onclick="deleteLine(${line.position})" title="Delete this line">Ã—</button>`;

    return `<tr class="status-${line.status}">
      <td class="line-num">${line.position + 1}</td>
      <td class="line-status">${pillHtml(line.status)}</td>
      <td class="line-text">${esc(line.raw_text)}</td>
      <td class="line-messages">${msgs.join('<br>')}</td>
      <td class="edit-col">${editBtn}${insBtn}${delBtn}</td>
    </tr>`;
  }).join('');
}

// ---- Delete Line ----

async function deleteLine(position) {
  const line = linesData[position];
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${position}`,
      { method: 'DELETE' }
    );
    if (!res.ok) {
      const err = await res.json();
      return alert(`Delete failed: ${err.detail || res.statusText}`);
    }
    // If the deleted line was being edited, close the panel
    if (editingPosition === position) closeEdit();
    // Adjust editing position if it was after the deleted line
    else if (editingPosition !== null && editingPosition > position) editingPosition--;
    await refreshLines();
    // Update doc title line count
    const titleEl = document.getElementById('doc-title');
    titleEl.textContent = titleEl.textContent.replace(
      /\(\d+ lines\)/, `(${linesData.length} lines)`
    );
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ---- Insert Line ----

async function insertLineAt(position) {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${position}/insert`,
      { method: 'POST' }
    );
    if (!res.ok) {
      const err = await res.json();
      return alert(`Insert failed: ${err.detail || res.statusText}`);
    }
    // Adjust editing position if it was at or after the insertion point
    if (editingPosition !== null && editingPosition >= position) editingPosition++;
    await refreshLines();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ---- Edit Flow ----

async function startEdit(position) {
  try {
    const res = await fetch(`${API}/documents/${currentDocId}/lines/${position}/session`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({fields: null})
    });
    if (!res.ok) return alert('Failed to start edit');
    const result = await res.json();
    editingPosition = position;
    editingLineData = result.data;

    document.getElementById('edit-line-num').textContent = `#${position + 1}`;
    renderEditForm(result.doc_type, result.data);
    document.getElementById('edit-panel').classList.add('open');
    document.getElementById('edit-result').classList.remove('show');
    document.getElementById('edit-panel').scrollIntoView({behavior: 'smooth'});

    // For mutex, load the session state
    if (result.doc_type === 'mutex') {
      await refreshMutexSession();
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function renderEditForm(docType, data) {
  const form = document.getElementById('edit-form');
  const actions = document.getElementById('edit-actions');

  if (docType === 'af') {
    actions.innerHTML = `
      <button onclick="submitEdit()">Apply</button>
      <button class="cancel-btn" onclick="closeEdit()">Cancel</button>`;
    form.innerHTML = `
      <div class="field-group">
        <label>Template</label>
        <input type="text" id="f-template" value="${esc(data.template || '')}">
      </div>
      <div class="field-group">
        <label>Net</label>
        <input type="text" id="f-net" value="${esc(data.net || '')}">
      </div>
      <div class="field-group">
        <label>AF Value</label>
        <input type="number" id="f-af_value" step="0.001" min="0" max="1" value="${data.af_value}">
      </div>
      <div class="field-group">
        <label>Flags</label>
        <div class="checkbox-row">
          <label><input type="checkbox" id="f-is_template_regex" ${data.is_template_regex ? 'checked' : ''}> Template Regex</label>
          <label><input type="checkbox" id="f-is_net_regex" ${data.is_net_regex ? 'checked' : ''}> Net Regex</label>
          <label><input type="checkbox" id="f-is_em_enabled" ${data.is_em_enabled ? 'checked' : ''}> EM</label>
          <label><input type="checkbox" id="f-is_sh_enabled" ${data.is_sh_enabled ? 'checked' : ''}> SH</label>
          <label><input type="checkbox" id="f-is_sch_enabled" ${data.is_sch_enabled ? 'checked' : ''}> SCH</label>
        </div>
      </div>

      <!-- AF NQS Query Preview -->
      <div class="query-section">
        <h3>NQS Query Preview</h3>
        <div class="query-row">
          <button class="teal-btn small-btn" onclick="afQueryPreview()">Search NQS</button>
          <span id="af-query-info" style="font-size:11px; color:var(--subtext)"></span>
        </div>
        <div id="af-query-results" class="query-results"></div>
      </div>`;
  } else {
    // ---- Mutex edit form ----
    actions.innerHTML = `
      <button class="save-btn" onclick="commitMutex()">Commit to Document</button>
      <button class="cancel-btn" onclick="closeEdit()">Cancel</button>`;

    form.innerHTML = `
      <div class="field-group">
        <label>Template</label>
        <input type="text" id="f-template" value="${esc(data.template || '')}">
      </div>
      <div class="field-group">
        <label>FEV Mode</label>
        <select id="f-fev" onchange="mutexSetFev()">
          <option value="" ${data.fev === '' ? 'selected' : ''}>(none)</option>
          <option value="low" ${data.fev === 'low' ? 'selected' : ''}>low</option>
          <option value="high" ${data.fev === 'high' ? 'selected' : ''}>high</option>
          <option value="ignore" ${data.fev === 'ignore' ? 'selected' : ''}>ignore</option>
        </select>
      </div>

      <!-- NQS Query Section -->
      <div class="query-section">
        <h3>NQS Net Query</h3>
        <div class="query-row">
          <input type="text" id="q-net-pattern" placeholder="Net pattern (e.g. vcc.* or vdd_core)">
          <label style="display:flex; align-items:center; gap:4px; font-size:12px">
            <input type="checkbox" id="q-is-regex" style="width:14px; height:14px"> Regex
          </label>
          <button class="teal-btn small-btn" onclick="mutexSearchNets()">Search</button>
          <button class="small-btn" onclick="mutexAddFromInput()">Add to Mutexed</button>
        </div>
        <div id="mutex-query-results" class="query-results"></div>
      </div>

      <!-- Session Info -->
      <div id="mutex-session-info" class="session-info"></div>

      <!-- Mutexed / Active lists side by side -->
      <div class="lists-container">
        <div class="entry-list">
          <div class="entry-list-header">
            <span>Mutexed Nets</span>
            <span class="count" id="mutexed-count">0</span>
          </div>
          <div class="entry-list-body" id="mutexed-list"></div>
        </div>
        <div class="entry-list">
          <div class="entry-list-header">
            <span style="color:var(--teal)">Active Nets</span>
            <span class="count" id="active-count">0</span>
          </div>
          <div class="entry-list-body" id="active-list"></div>
        </div>
      </div>`;
  }
}

// ==================================================================
// AF: Query Preview
// ==================================================================

async function afQueryPreview() {
  const template = document.getElementById('f-template').value;
  const net = document.getElementById('f-net').value;
  const templateRegex = document.getElementById('f-is_template_regex').checked;
  const netRegex = document.getElementById('f-is_net_regex').checked;

  const info = document.getElementById('af-query-info');
  info.textContent = 'Searching...';

  try {
    const res = await fetch(`${API}/query-nets`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        template, net_pattern: net,
        template_regex: templateRegex, net_regex: netRegex
      })
    });
    const data = await res.json();
    if (!res.ok) {
      info.textContent = `Error: ${data.detail || 'query failed'}`;
      return;
    }

    const resultsDiv = document.getElementById('af-query-results');
    const nets = data.nets || [];
    const templates = data.templates || [];

    let html = '';
    if (nets.length || templates.length) {
      html += `<div class="result-count">Matched ${nets.length} net(s), ${templates.length} template(s)</div>`;
      for (const n of nets) {
        html += `<div class="result-item"><span>${esc(n)}</span></div>`;
      }
      if (templates.length) {
        html += `<div class="result-count" style="margin-top:4px">Templates:</div>`;
        for (const t of templates) {
          html += `<div class="result-item"><span style="color:var(--lavender)">${esc(t)}</span></div>`;
        }
      }
    } else {
      html = `<div class="result-count">No matches found</div>`;
    }
    resultsDiv.innerHTML = html;
    info.textContent = `${nets.length} net(s), ${templates.length} template(s)`;
  } catch (e) {
    info.textContent = 'Error: ' + e.message;
  }
}

// ==================================================================
// Mutex: NQS Search
// ==================================================================

async function mutexSearchNets() {
  const template = normalizeTemplateInput(document.getElementById('f-template').value);
  const pattern = document.getElementById('q-net-pattern').value;
  const isRegex = document.getElementById('q-is-regex').checked;

  const resultsDiv = document.getElementById('mutex-query-results');
  resultsDiv.innerHTML = '<div class="result-count">Searching...</div>';

  try {
    const res = await fetch(`${API}/query-nets`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        template, net_pattern: pattern,
        template_regex: false, net_regex: isRegex
      })
    });
    const data = await res.json();
    if (!res.ok) {
      resultsDiv.innerHTML = `<div class="result-count" style="color:var(--red)">Error: ${esc(data.detail || 'query failed')}</div>`;
      return;
    }

    const nets = data.nets || [];
    let html = `<div class="result-count">${nets.length} net(s) found</div>`;
    for (const n of nets) {
      html += `<div class="result-item">
        <span>${esc(n)}</span>
        <span class="entry-actions">
          <button class="small-btn" onclick="mutexAddNet('${esc(n).replace(/'/g, "\\'")}')">+ Mutexed</button>
          <button class="small-btn teal-btn" onclick="mutexAddNetActive('${esc(n).replace(/'/g, "\\'")}')">+ Active</button>
        </span>
      </div>`;
    }
    if (!nets.length) {
      html = `<div class="result-count">No matches found</div>`;
    }
    resultsDiv.innerHTML = html;
  } catch (e) {
    resultsDiv.innerHTML = `<div class="result-count" style="color:var(--red)">Error: ${e.message}</div>`;
  }
}

// ==================================================================
// Mutex: Session Operations (via controller API)
// ==================================================================

async function mutexAddFromInput() {
  const template = normalizeTemplateInput(document.getElementById('f-template').value);
  const pattern = document.getElementById('q-net-pattern').value;
  const isRegex = document.getElementById('q-is-regex').checked;
  if (!pattern) return showResult('Enter a net pattern first', false);
  await mutexAddMutexed(template, pattern, isRegex);
}

async function mutexAddNet(netName) {
  const template = normalizeTemplateInput(document.getElementById('f-template').value);
  // Individual nets from search results are added as non-regex
  await mutexAddMutexed(template, netName, false);
}

async function mutexAddNetActive(netName) {
  const template = normalizeTemplateInput(document.getElementById('f-template').value);
  // Add directly to active (session handles idempotent mutexed add)
  await mutexAddActive(template, netName);
}

async function mutexAddMutexed(template, netPattern, isRegex) {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/add-mutexed`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ template, net_pattern: netPattern, is_regex: isRegex })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Add mutexed failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
    showResult(`Added "${netPattern}" to mutexed`, true);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

async function mutexAddActive(template, netName) {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/add-active`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ template, net_name: netName })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Add active failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
    showResult(`Added "${netName}" to active`, true);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

async function mutexRemoveMutexed(template, netPattern, isRegex) {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/remove-mutexed`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ template, net_pattern: netPattern, is_regex: isRegex })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Remove mutexed failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
    showResult(`Removed "${netPattern}" from mutexed`, true);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

async function mutexRemoveActive(template, netName) {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/remove-active`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ template, net_name: netName })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Remove active failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
    showResult(`Removed "${netName}" from active`, true);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

async function mutexSetNumActive(value) {
  const val = parseInt(value);
  if (isNaN(val)) return;
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/set-num-active`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ value: val })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Set num_active failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

async function mutexSetFev() {
  const fev = document.getElementById('f-fev').value;
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/set-fev`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ fev })
      }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Set FEV failed: ${data.detail}`, false);
      return;
    }
    mutexSession = data;
    renderMutexSession(data);
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

// ==================================================================
// Mutex: Session State Rendering
// ==================================================================

async function refreshMutexSession() {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/mutex/session`
    );
    if (res.ok) {
      mutexSession = await res.json();
      renderMutexSession(mutexSession);
    }
  } catch (e) {
    console.error('Failed to refresh mutex session:', e);
  }
}

function renderMutexSession(session) {
  // Session info bar
  const infoDiv = document.getElementById('mutex-session-info');
  if (infoDiv) {
    const hasActiveEntries = session.active_entries.length > 0;
    const numActiveControl = hasActiveEntries
      ? `<span class="val">${session.num_active}</span> <span style="font-size:10px">(derived from active list)</span>`
      : `<input type="number" id="f-num-active" min="0" value="${session.num_active}"
           style="width:50px; background:var(--bg); border:1px solid var(--overlay); color:var(--text); padding:2px 6px; border-radius:3px; font-family:inherit; font-size:12px"
           onchange="mutexSetNumActive(this.value)">`;
    infoDiv.innerHTML = `
      <span>Template: <span class="val">${session.template || '(none)'}</span></span>
      <span>Regex mode: <span class="val">${session.regex_mode === null ? '(unset)' : session.regex_mode}</span></span>
      <span>Num active: ${numActiveControl}</span>
      <span>FEV: <span class="val">${session.fev || '(none)'}</span></span>
    `;
  }

  // Build set of active net names for quick lookup
  const activeNames = new Set(session.active_entries.map(e => e.net_name));

  // Mutexed list
  const mutexedList = document.getElementById('mutexed-list');
  const mutexedCount = document.getElementById('mutexed-count');
  if (mutexedList) {
    mutexedCount.textContent = session.mutexed_entries.length;
    if (session.mutexed_entries.length === 0) {
      mutexedList.innerHTML = '<div style="padding:8px 10px; color:var(--subtext); font-size:11px">No entries yet</div>';
    } else {
      mutexedList.innerHTML = session.mutexed_entries.map(e => {
        const isActive = activeNames.has(e.net_name);
        const matchInfo = e.match_count > 0
          ? `<span class="net-meta">${e.match_count} match${e.match_count !== 1 ? 'es' : ''}</span>`
          : '<span class="net-meta" style="color:var(--red)">no matches</span>';
        const regexBadge = e.regex_mode
          ? '<span class="net-meta" style="color:var(--peach)">regex</span>'
          : '';

        // Promote-to-active button: only for non-regex, single-match entries not already active
        const canPromote = !e.regex_mode && e.match_count === 1 && !isActive;
        const promoteBtn = canPromote
          ? `<button class="small-btn teal-btn" onclick="mutexAddActive(${jsArg(e.template_name)},'${jsStr(e.net_name)}')" title="Promote to Active">â†’A</button>`
          : '';

        const removeBtn = `<button class="small-btn danger-btn" onclick="mutexRemoveMutexed(${jsArg(e.template_name)},'${jsStr(e.net_name)}',${e.regex_mode})" title="Remove">Ã—</button>`;

        return `<div class="entry-item ${isActive ? 'entry-item-active' : ''}">
          <span class="net-name">${esc(e.net_name)}</span>
          ${regexBadge}${matchInfo}
          <span class="entry-actions">${promoteBtn}${removeBtn}</span>
        </div>`;
      }).join('');
    }
  }

  // Active list
  const activeList = document.getElementById('active-list');
  const activeCount = document.getElementById('active-count');
  if (activeList) {
    activeCount.textContent = session.active_entries.length;
    if (session.active_entries.length === 0) {
      activeList.innerHTML = '<div style="padding:8px 10px; color:var(--subtext); font-size:11px">No active entries</div>';
    } else {
      activeList.innerHTML = session.active_entries.map(e => {
        const removeBtn = `<button class="small-btn danger-btn" onclick="mutexRemoveActive(${jsArg(e.template_name)},'${jsStr(e.net_name)}')" title="Remove from Active">Ã—</button>`;
        return `<div class="entry-item entry-item-active">
          <span class="net-name">${esc(e.net_name)}</span>
          <span class="net-meta">${e.match_count} match</span>
          <span class="entry-actions">${removeBtn}</span>
        </div>`;
      }).join('');
    }
  }
}

// Helper: escape string for JS inline onclick
function jsStr(s) {
  if (s === null || s === undefined) return '';
  s = String(s);
  return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function jsArg(s) {
  if (s === null || s === undefined) return 'null';
  return `'${jsStr(s)}'`;
}

function normalizeTemplateInput(template) {
  if (template === null || template === undefined) return null;
  const trimmed = String(template).trim();
  return trimmed === '' ? null : trimmed;
}

// ==================================================================
// Mutex: Commit
// ==================================================================

async function commitMutex() {
  await commitToDocument();
}

// ==================================================================
// AF: Gather fields & Submit (existing flow)
// ==================================================================

function gatherFields() {
  if (currentDocType === 'af') {
    return {
      template: document.getElementById('f-template').value,
      net: document.getElementById('f-net').value,
      af_value: parseFloat(document.getElementById('f-af_value').value),
      is_template_regex: document.getElementById('f-is_template_regex').checked,
      is_net_regex: document.getElementById('f-is_net_regex').checked,
      is_em_enabled: document.getElementById('f-is_em_enabled').checked,
      is_sh_enabled: document.getElementById('f-is_sh_enabled').checked,
      is_sch_enabled: document.getElementById('f-is_sch_enabled').checked,
    };
  } else {
    // Fallback for mutex (not used in interactive flow)
    const mnRaw = document.getElementById('f-mutexed_nets')?.value || '';
    const anRaw = document.getElementById('f-active_nets')?.value || '';
    return {
      num_active: parseInt(document.getElementById('f-num_active')?.value || '1'),
      fev: document.getElementById('f-fev')?.value || '',
      template: normalizeTemplateInput(document.getElementById('f-template')?.value),
      is_net_regex: document.getElementById('f-is_net_regex')?.checked || false,
      mutexed_nets: mnRaw ? mnRaw.split(',').map(s => s.trim()).filter(Boolean) : [],
      active_nets: anRaw ? anRaw.split(',').map(s => s.trim()).filter(Boolean) : [],
    };
  }
}

async function submitEdit() {
  const fields = gatherFields();
  try {
    // Step 1: update session with gathered fields
    const updateRes = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/session`,
      {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ fields })
      }
    );
    if (!updateRes.ok) {
      const err = await updateRes.json();
      showResult(`Error: ${err.detail || JSON.stringify(err)}`, false);
      return;
    }
    // Step 2: commit session to document
    await commitToDocument();
  } catch (e) {
    showResult('Request failed: ' + e.message, false);
  }
}

/** Commit the current edit session to the document (any doc type). */
async function commitToDocument() {
  try {
    const res = await fetch(
      `${API}/documents/${currentDocId}/lines/${editingPosition}/commit`,
      { method: 'POST' }
    );
    const data = await res.json();
    if (!res.ok) {
      showResult(`Commit failed: ${data.detail || JSON.stringify(data)}`, false);
      return;
    }
    const msgs = [...(data.errors || []), ...(data.warnings || [])];
    if (data.status === 'ok') {
      showResult('âœ“ Committed â€” line is OK', true);
    } else if (data.status === 'warning') {
      showResult(`âœ“ Committed with warnings: ${msgs.join('; ')}`, true);
    } else {
      showResult(`Committed with errors: ${msgs.join('; ')}`, false);
    }
    await refreshLines();
  } catch (e) {
    showResult('Error: ' + e.message, false);
  }
}

function closeEdit() {
  document.getElementById('edit-panel').classList.remove('open');
  editingPosition = null;
  editingLineData = null;
  mutexSession = null;
}

// ---- Save ----

async function saveDoc() {
  if (!currentDocId) return;
  try {
    const res = await fetch(`${API}/documents/${currentDocId}/save`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (res.ok) {
      alert(`Saved to: ${data.file_path}`);
    } else {
      alert(`Save failed: ${data.detail}`);
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ---- Pre-fill with example paths ----
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('file-path').value =
    'C:/Projects/lotus-ref/data/cfg/mycell.af.dcfg';
});
</script>
</body>
</html>
